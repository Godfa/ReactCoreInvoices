# Migration from SQL Server to PostgreSQL

## Overview

MokkilanInvoices has been migrated from SQL Server (Azure SQL + LocalDB) to PostgreSQL. This document explains what changed and how to migrate existing deployments.

## What Changed

### NuGet Packages

**Added:**
- `Npgsql.EntityFrameworkCore.PostgreSQL` (8.0.*)

**Kept (still needed):**
- `Microsoft.EntityFrameworkCore.SqlServer` - Can be removed if no longer needed
- `Microsoft.EntityFrameworkCore.Sqlite` - Can be removed if no longer needed

### Code Changes

**ApplicationServiceExtensions.cs** ([API/Extensions/ApplicationServiceExtensions.cs:27-39](API/Extensions/ApplicationServiceExtensions.cs#L27-L39))
- Changed from conditional `UseSqlServer` / `UseSqlite` to `UseNpgsql`
- Added PostgreSQL-specific retry configuration

**appsettings.json**
- Connection string changed from SQL Server format to PostgreSQL format
- Passwords removed from config files (use environment variables or user-secrets)

**Migrations**
- All old SQL Server migrations removed
- New `InitialPostgreSQL` migration created with full schema

### Connection String Format

**Old (SQL Server):**
```
Server=tcp:mlan-invoicer.database.windows.net,1433;Initial Catalog=mlan-invoicer-db;...
```

**New (PostgreSQL):**
```
Host=localhost;Port=5432;Database=LanInvoices;Username=postgres;Password=your_password
```

## Migration Steps

### For Fresh Installations

1. Follow the setup guide in [POSTGRESQL_SETUP.md](POSTGRESQL_SETUP.md)
2. Run the application - migrations and seed data apply automatically

### For Existing Azure SQL Server Deployments

If you have existing data in Azure SQL Server that you want to migrate:

#### Option 1: Export/Import Data (Recommended)

1. **Export data from SQL Server**
   ```bash
   # Using SQL Server Management Studio or sqlcmd
   # Export to CSV or SQL INSERT scripts
   ```

2. **Setup PostgreSQL database**
   ```bash
   # Create new PostgreSQL database
   psql -U postgres -c "CREATE DATABASE \"LanInvoices\";"
   ```

3. **Run the application once to create schema**
   ```bash
   cd API
   dotnet run
   # This will create all tables via EF migrations
   ```

4. **Import data into PostgreSQL**
   ```bash
   # Using psql or pgAdmin
   # Import from CSV or run INSERT scripts
   ```

#### Option 2: Manual Data Transfer

1. **Backup existing Azure SQL database**
   ```bash
   # From Azure Portal or using sqlcmd
   ```

2. **Setup new PostgreSQL database** (see POSTGRESQL_SETUP.md)

3. **Create tables with EF migrations**
   ```bash
   cd API
   dotnet ef database update --project ../Persistence
   ```

4. **Transfer data manually** using tools like:
   - [pgLoader](https://pgloader.io/) - SQL Server to PostgreSQL data transfer
   - Azure Data Studio with PostgreSQL extension
   - Custom C# migration script

#### Option 3: Parallel Run (Zero Downtime)

1. Setup PostgreSQL alongside existing SQL Server
2. Run new version pointing to PostgreSQL
3. Sync data from SQL Server to PostgreSQL during migration period
4. Switch production traffic to PostgreSQL version
5. Decommission SQL Server

## Schema Compatibility

The PostgreSQL schema is functionally identical to the SQL Server schema:

- **Identity Tables**: AspNetUsers, AspNetRoles, etc. (same structure)
- **Invoices**: Same columns and relationships
- **ExpenseItems**: Same columns and relationships
- **ExpenseLineItems**: Same columns and relationships
- **InvoiceParticipants**: Same join table structure
- **ExpenseItemPayers**: Same join table structure
- **InvoiceApprovals**: Same columns and relationships

### Differences to Note

1. **Auto-increment columns**
   - SQL Server: `IDENTITY(1,1)`
   - PostgreSQL: `SERIAL` or `GENERATED BY DEFAULT AS IDENTITY`
   - EF Core handles this automatically

2. **Case sensitivity**
   - PostgreSQL is case-sensitive for table/column names by default
   - EF Core uses quoted identifiers to ensure compatibility

3. **Boolean types**
   - SQL Server: `BIT`
   - PostgreSQL: `BOOLEAN`
   - EF Core maps correctly

4. **Date/Time**
   - SQL Server: `DATETIME2`
   - PostgreSQL: `TIMESTAMP WITHOUT TIME ZONE`
   - Both store UTC, no issues

## Testing the Migration

After migration, verify:

1. **Authentication works**
   ```bash
   # Login with existing users
   # Create new users
   ```

2. **Invoice operations**
   ```bash
   # Create new invoice
   # Edit existing invoice
   # Delete invoice (cascade deletes work)
   ```

3. **Expense tracking**
   ```bash
   # Add expense items
   # Add line items
   # Assign payers
   ```

4. **PDF generation**
   ```bash
   # Generate invoice PDF
   # Verify all data appears correctly
   ```

5. **Email notifications**
   ```bash
   # Send payment notification
   # Verify email content
   ```

## Rollback Plan

If you need to rollback to SQL Server:

1. **Keep your old SQL Server database** (don't delete until PostgreSQL is proven stable)

2. **Git checkout** the commit before PostgreSQL migration:
   ```bash
   git log --oneline  # Find commit before "PostgreSQL migration"
   git checkout <commit-hash>
   ```

3. **Restore old NuGet packages**
   ```bash
   cd Persistence
   dotnet restore
   ```

4. **Update connection string** back to SQL Server

5. **Deploy old version**

## Performance Considerations

PostgreSQL typically performs differently than SQL Server:

- **Indexing**: PostgreSQL has excellent index support, similar to SQL Server
- **Connection pooling**: Built-in via Npgsql, configured in connection string
- **Query optimization**: Different query planner, may need ANALYZE/VACUUM
- **JSON support**: Better native JSON support than SQL Server

Monitor performance after migration and adjust indexes if needed.

## Cost Comparison

**Before (Azure SQL Server):**
- Azure SQL Database: ~$5-50+/month depending on tier
- Requires Azure subscription

**After (PostgreSQL):**
- Self-hosted: Free (only server costs)
- Managed options: AWS RDS, Azure Database for PostgreSQL, Digital Ocean (~$15-30/month)
- More flexible hosting options

## Support

For issues with the migration:

1. Check [POSTGRESQL_SETUP.md](POSTGRESQL_SETUP.md) for common troubleshooting
2. Review connection string format and environment variables
3. Ensure PostgreSQL service is running
4. Check application logs for EF Core errors

## Summary

âœ… **Completed:**
- Replaced SQL Server/SQLite with PostgreSQL
- Updated EF Core configuration
- Created new PostgreSQL migrations
- Added comprehensive setup documentation
- Removed passwords from config files

ðŸŽ¯ **Benefits:**
- No Azure dependency
- Lower costs
- Better JSON support
- More flexible hosting options
- Open source database

ðŸ“š **Documentation:**
- [POSTGRESQL_SETUP.md](POSTGRESQL_SETUP.md) - Setup and configuration guide
- [README.md](README.md) - Updated with PostgreSQL prerequisites
- [CLAUDE.md](CLAUDE.md) - Updated development guide
- [.env.example](API/.env.example) - Environment variable template
